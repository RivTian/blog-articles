#Rust #Algorithm

在日常的编程中，经常会有需求要判断一个数组的元素是否全为0，比如说，在写一个存储程序的mock server的时候，如果slice数据全为0的话，在mock server中只需要存储对应的长度就可以了，能优化很多的操作。本篇文章介绍判断数组是否全为0的4种方法，尤其是最后一种方法，性能提升了40多倍。

判断数组是否全为0，函数的定义如下：

```rust
pub fn is_all_zero(data: &[u8]) -> bool {
	todo!()
}
```

## 方法一、无脑遍历 O(n)

```rust
pub fn is_all_zero(data: &[u8]) -> bool {
	for i in 0..data.len() {
		if data[i] != 0 {
			return false
		}
	}
	true
}
```

这种方法的缺点很明显，每次data的取下标操作，rust都会运行时判断是否overflow，因此会有额外的性能损耗。在rust中，是非常不建议这种写法的。

## 方法二、迭代器遍历

在 Rust 中更推荐使用迭代器来遍历数组，Code 如下：

```rust
pub fn is_all_zero(data: &[u8]) -> bool {
	data.iter().all(|&i| i == 0)
}
```

Rust 的迭代器绕过了刚才运行时下标是否 overflow 的判断，因此对比第一种方式性能更强，是 idiomatic 的写法，比较推荐。

## 方法三、转换为更大的元素进行遍历

上面的遍历中，每次都是判断一个 u8 的元素是否为 0，如果咱们把数组元素从 u8 转换为 u128 的话，能大幅度减少遍历以及分支判断的次数：

```rust
pub fn is_all_zero(data: &[u8]) -> bool {
	let (prefix, aligned, suffix) = unsafe { data.align_to::<u128>() };
    prefix.iter().all(|&x| x == 0)
        && aligned.iter().all(|&x| x == 0)
        && suffix.iter().all(|&x| x == 0)
}
```

如上面的代码，咱们使用slice的align_to方法[slice method.align_to](https://doc.rust-lang.org/std/primitive.slice.html#method.align_to)，把原来的数组转换成了3部分，按照u128对齐的部分，以及前后剩余的部分，然后分别判断这3部分是否都全为0。

## 方法四：simd单指令流多数据流遍历

判断一个数组是否全为0，是一个典型的数据流的操作，很自然的会想到simd：

```rust
pub fn is_all_zeros_simd(data: &[u8]) -> bool {
    let (prefix, aligned, suffix) = unsafe { data.align_to::<Simd<usize, 64>>() };
    prefix.iter().all(|&x| x == 0)
        && suffix.iter().all(|&x| x == 0)
        && aligned.iter().all(|&x| x.reduce_or() == 0)
}
```

rust中simd相关的intrinsics还是Experimental的，要开启#![feature(portable_simd)]才行。

上面4种方法，执行cargo bench使用criterion压测对比性能，会在target/criterion/is_all_zeros/report/index.html文件中，生成了一个印刷级的特别漂亮的性能报告。从报告中可以看出，性能的差异还是非常的明显的：

![](https://pic2.zhimg.com/80/v2-76a639b8ce176f5c48677cd663c19689_1440w.webp)

如上图所示，性能最差劲的是无脑遍历的实现，平均耗时在440微秒左右，性能最牛逼的是simd的实现，平均耗时在9微秒左右，性能提升了40多倍。

而且stupid无脑遍历的实现，有比较多的outliers点，方差较大，而simd的实现，平均耗时基本上集中在一个点上，性能非常的稳定。

以上所有的代码都在 [https://github.com/yaozongyou/hello/tree/main/isallzeros](https://github.com/yaozongyou/hello/tree/main/isallzeros) ，欢迎点赞和评论，感谢。