![](https://upload-images.jianshu.io/upload_images/1489066-2daebb1d1c51bfea.gif?imageMogr2/auto-orient/strip|imageView2/2/w/1200)

[è½¬åˆ°github](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%23examples)

nlohmann::jsonåœ¨é¡¹ç›®ä¸­çš„å®é™…ä½¿ç”¨è¯¦è§C++é™æ€ä»£ç æ£€æµ‹å·¥å…·ï¼š[cppdetector](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fzhlongfj%2Fcppdetector)

## è®¾è®¡ç›®æ ‡

å·²ç»æœ‰æ— æ•°çš„[JSON](https://links.jianshu.com/go?to=http%3A%2F%2Fjson.org%2F)åº“ï¼Œæ¯ä¸ªåº“éƒ½æœ‰å…¶å­˜åœ¨çš„ç†ç”±ã€‚æˆ‘ä»¬æœ‰è¿™äº›è®¾è®¡ç›®æ ‡ï¼š

- **ç›´è§‚çš„è¯­æ³•**ã€‚åœ¨åƒPythonè¿™æ ·çš„è¯­è¨€ä¸­ï¼ŒJSONæ„Ÿè§‰å°±åƒæ˜¯ä¸€çº§æ•°æ®ç±»å‹ã€‚æˆ‘ä»¬ä½¿ç”¨ç°ä»£C++çš„æ“ä½œé­”æ³•æ¥å®ç°ç±»ä¼¼æ™®é€šä»£ç èˆ¬çš„æ„Ÿè§‰ã€‚çœ‹çœ‹[ä¸‹é¢çš„ä¾‹å­](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%23examples)ï¼Œä½ å°±ä¼šæ˜ç™½æˆ‘çš„æ„æ€ã€‚
    
- **æ•´åˆ**ã€‚æˆ‘ä»¬çš„æ•´ä¸ªä»£ç åªæœ‰ä¸€ä¸ªå¤´æ–‡ä»¶[`json.hpp`](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fblob%2Fdevelop%2Fsingle_include%2Fnlohmann%2Fjson.hpp)ã€‚æ²¡æœ‰åº“ï¼Œæ²¡æœ‰å­é¡¹ç›®ï¼Œæ²¡æœ‰ä¾èµ–é¡¹ï¼Œæ²¡æœ‰å¤æ‚çš„æ„å»ºç³»ç»Ÿï¼Œä»…ä»…ä½¿ç”¨æ ‡å‡†C ++ 11ç¼–å†™ã€‚æ€»è€Œè¨€ä¹‹ï¼Œä¸éœ€è¦è°ƒæ•´ä»»ä½•ç¼–è¯‘å™¨æ ‡å¿—æˆ–é¡¹ç›®è®¾ç½®ã€‚
    
- **å‹åŠ›æµ‹è¯•**ã€‚æˆ‘ä»¬çš„ç±»ç»è¿‡ä¸¥æ ¼çš„[å•å…ƒæµ‹è¯•](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Ftree%2Fdevelop%2Ftest%2Fsrc)ï¼Œæ¶µç›–äº†[100ï¼…](https://links.jianshu.com/go?to=https%3A%2F%2Fcoveralls.io%2Fr%2Fnlohmann%2Fjson)çš„ä»£ç ï¼ŒåŒ…æ‹¬æ‰€æœ‰ç‰¹æ®Šè¡Œä¸ºã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨[Valgrind](https://links.jianshu.com/go?to=http%3A%2F%2Fvalgrind.org%2F)å’Œ[Clang Sanitizers](https://links.jianshu.com/go?to=https%3A%2F%2Fclang.llvm.org%2Fdocs%2Findex.html)åšäº†æ£€æµ‹ï¼Œæ²¡æœ‰å†…å­˜æ³„æ¼ã€‚è¿˜ä½¿ç”¨[è°·æ­ŒOSS-Fuzz](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fgoogle%2Foss-fuzz%2Ftree%2Fmaster%2Fprojects%2Fjson)å¯¹æ‰€æœ‰è§£æå™¨è¿›è¡Œ24/7æ¨¡ç³Šæµ‹è¯•ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æœ‰æ•ˆåœ°æ‰§è¡Œäº†æ•°åäº¿æ¬¡æµ‹è¯•ã€‚ä¸ºäº†ä¿æŒé«˜è´¨é‡ï¼Œè¯¥é¡¹ç›®éµå¾ª[æ ¸å¿ƒåŸºç¡€è®¾æ–½å€¡è®®ï¼ˆCIIï¼‰çš„æœ€ä½³å®è·µ](https://links.jianshu.com/go?to=https%3A%2F%2Fbestpractices.coreinfrastructure.org%2Fprojects%2F289)ã€‚
    

å¯¹æˆ‘ä»¬æ¥è¯´å¹¶ä¸é‚£ä¹ˆé‡è¦çš„å…¶ä»–æ–¹é¢ï¼š

- **å†…å­˜æ•ˆç‡**ã€‚æ¯ä¸ªJSONå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ˆè”åˆçš„æœ€å¤§å¤§å°ï¼‰å’Œä¸€ä¸ªæšä¸¾å…ƒç´ ï¼ˆ1ä¸ªå­—èŠ‚ï¼‰çš„å¼€é”€ã€‚é»˜è®¤æ³›åŒ–ä½¿ç”¨ä»¥ä¸‹C ++æ•°æ®ç±»å‹ï¼š`std::string`ç”¨äºå­—ç¬¦ä¸²ï¼Œ`int64_t`ï¼Œ`uint64_t`æˆ–`double`ç”¨äºæ•°å­—ï¼Œ`std::map`ç”¨äºå¯¹è±¡ï¼Œ`std::vector`ç”¨äºæ•°ç»„å’Œ`bool`ç”¨äºå¸ƒå°”å€¼ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ç‰¹åŒ–`basic_json`é€šç”¨ç±»ã€‚
    
- **é€Ÿåº¦**ã€‚è‚¯å®šæœ‰[æ›´å¿«çš„JSONåº“](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fmiloyip%2Fnativejson-benchmark%23parsing-time)ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯é€šè¿‡æ·»åŠ å•ä¸ªå¤´æ–‡ä»¶æ·»åŠ JSONæ”¯æŒæ¥åŠ é€Ÿå¼€å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªåº“å°±æ˜¯æ‚¨çš„é€‰æ‹©ã€‚å¦‚æœæ‚¨çŸ¥é“å¦‚ä½•ä½¿ç”¨`std::vector`æˆ–`std::map`ï¼Œä½ å°±å·²ç»å‡†å¤‡å¥½äº†ã€‚
    

æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[è´¡çŒ®æŒ‡å—](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fblob%2Fmaster%2F.github%2FCONTRIBUTING.md%23please-dont)ã€‚

- **æ•´åˆ**  
    [`json.hpp`](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fblob%2Fdevelop%2Fsingle_include%2Fnlohmann%2Fjson.hpp)å”¯ä¸€æ‰€éœ€çš„æ–‡ä»¶ï¼Œåœ¨ç›®å½•`single_include/nlohmann`æˆ–[è¿™é‡Œ](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Freleases)ã€‚ä½ éœ€è¦æ·»åŠ ï¼š

```source-c
#include <nlohmann/json.hpp>

// for convenience
using json = nlohmann::json;
```

åˆ°æ‚¨è¦å¤„ç†JSONçš„æ–‡ä»¶æ—¶ï¼Œè®¾ç½®å¿…è¦çš„å¼€å…³ä»¥å¯ç”¨C ++ 11ï¼ˆä¾‹å¦‚ï¼Œ`-std=c++11`å¯¹äºGCCå’ŒClangï¼‰ã€‚

æ‚¨å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨æ–‡ä»¶[`include/nlohmann/json_fwd.hpp`](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fblob%2Fdevelop%2Finclude%2Fnlohmann%2Fjson_fwd.hpp)è¿›è¡Œå‰å‘å£°æ˜ã€‚å®‰è£…json_fwd.hppï¼ˆä½œä¸ºcmakeå®‰è£…æ­¥éª¤çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®`-DJSON_MultipleHeaders=ON`æ¥å®ç°ã€‚

### åŒ…ç®¡ç†å™¨

ğŸºå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯OS Xå’Œ[Homebrew](https://links.jianshu.com/go?to=http%3A%2F%2Fbrew.sh%2F)ï¼Œåªéœ€é”®å…¥`brew tap nlohmann/json`å¹¶`brew install nlohmann_json`è®¾ç½®å³å¯ã€‚å¦‚æœæ‚¨æƒ³è¦æœ€æ–°ç‰ˆæœ¬è€Œä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨`brew install nlohmann_json --HEAD`ã€‚

å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨[Meson Build System](https://links.jianshu.com/go?to=http%3A%2F%2Fmesonbuild.com%2F)ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥å°†æ­¤å­˜å‚¨åº“åŒ…è£…ä¸ºå­é¡¹ç›®ã€‚

å¦‚æœæ‚¨ä½¿ç”¨[Conan](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.conan.io%2F)æ¥ç®¡ç†æ‚¨çš„ä¾èµ–é¡¹ï¼Œåªéœ€æ·»åŠ `jsonformoderncpp/x.y.z@vthiery/stable`æ‚¨`conanfile.py`çš„è¦æ±‚ï¼Œ`x.y.z`æ‚¨è¦ä½¿ç”¨çš„å‘è¡Œç‰ˆæœ¬åœ¨å“ªé‡Œã€‚å¦‚æœæ‚¨é‡åˆ°åŒ…è£…é—®é¢˜ï¼Œè¯·[åœ¨æ­¤å¤„æå‡º](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fvthiery%2Fconan-jsonformoderncpp%2Fissues)é—®é¢˜ã€‚

å¦‚æœæ‚¨ä½¿ç”¨[Spack](https://links.jianshu.com/go?to=https%3A%2F%2Fwww.spack.io%2F)æ¥ç®¡ç†ä¾èµ–é¡¹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¯¥`nlohmann_json`ç¨‹åºåŒ…ã€‚æœ‰å…³åŒ…è£…çš„ä»»ä½•é—®é¢˜ï¼Œè¯·å‚é˜…[spacké¡¹ç›®](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fspack%2Fspack)ã€‚

å¦‚æœä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨[çŒäºº](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fruslo%2Fhunter%2F)æ¥è·å–å¤–éƒ¨ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨[nlohmann_jsonåŒ…](https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.hunter.sh%2Fen%2Flatest%2Fpackages%2Fpkg%2Fnlohmann_json.html)ã€‚æœ‰å…³åŒ…è£…çš„ä»»ä½•é—®é¢˜ï¼Œè¯·å‚é˜…çŒäººé¡¹ç›®ã€‚

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯[Buckaroo](https://links.jianshu.com/go?to=https%3A%2F%2Fbuckaroo.pm%2F)ï¼Œåˆ™å¯ä»¥å®‰è£…æ­¤åº“çš„æ¨¡å—`buckaroo install nlohmann/json`ã€‚è¯·[åœ¨è¿™é‡Œ](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FLoopPerfect%2Fbuckaroo-recipes%2Fissues%2Fnew%3Ftitle%3Dnlohmann%2Fnlohmann%2Fjson)æå‡ºé—®é¢˜ã€‚

å¦‚æœæ‚¨åœ¨é¡¹ç›®ä¸­ä½¿ç”¨[vcpkg](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FMicrosoft%2Fvcpkg%2F)æ¥è·å–å¤–éƒ¨ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨[nlohmann-jsonåŒ…](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2FMicrosoft%2Fvcpkg%2Ftree%2Fmaster%2Fports%2Fnlohmann-json)ã€‚æœ‰å…³åŒ…è£…çš„ä»»ä½•é—®é¢˜ï¼Œè¯·å‚é˜…vcpkgé¡¹ç›®ã€‚

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯[cget](https://links.jianshu.com/go?to=http%3A%2F%2Fcget.readthedocs.io%2Fen%2Flatest%2F)ï¼Œåˆ™å¯ä»¥å®‰è£…æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬`cget install nlohmann/json`ã€‚å¯ä»¥å®‰è£…ç‰¹å®šç‰ˆæœ¬`cget install nlohmann/json@v3.1.0`ã€‚æ­¤å¤–ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ `-DJSON_MultipleHeaders=ON`æ ‡å¿—ï¼ˆå³ï¼Œ`cget install nlohmann/json -DJSON_MultipleHeaders=ON`ï¼‰æ¥å®‰è£…å¤šæ ‡å¤´ç‰ˆæœ¬ã€‚

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯[CocoaPods](https://links.jianshu.com/go?to=https%3A%2F%2Fcocoapods.org%2F)ï¼Œåˆ™å¯ä»¥é€šè¿‡å°†podæ·»åŠ `"nlohmann_json", '~>3.1.2'`åˆ°podfile æ¥ä½¿ç”¨è¯¥åº“ï¼ˆè¯·å‚é˜…[ç¤ºä¾‹](https://links.jianshu.com/go?to=https%3A%2F%2Fbitbucket.org%2Fbenman%2Fnlohmann_json-cocoapod%2Fsrc%2Fmaster%2F)ï¼‰ã€‚è¯·[åœ¨è¿™é‡Œ](https://links.jianshu.com/go?to=https%3A%2F%2Fbitbucket.org%2Fbenman%2Fnlohmann_json-cocoapod%2Fissues%3Fstatus%3Dnew%26status%3Dopen)æå‡ºé—®é¢˜ã€‚

## ä¾‹å­

é™¤äº†ä¸‹é¢çš„ç¤ºä¾‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æŸ¥çœ‹æ¯ä¸ªå‡½æ•°ï¼ˆåŒ…å«å•ç‹¬ä»£ç ç¤ºä¾‹ï¼‰çš„[æ–‡æ¡£](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2F)ï¼ˆä¾‹å¦‚ï¼ŒæŸ¥çœ‹[`emplace()`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_a5338e282d1d02bed389d852dd670d98d.html%23a5338e282d1d02bed389d852dd670d98d)ï¼‰ã€‚æ‰€æœ‰[ç¤ºä¾‹æ–‡ä»¶](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Ftree%2Fdevelop%2Fdoc%2Fexamples)éƒ½å¯ä»¥è‡ªå·±ç¼–è¯‘å’Œæ‰§è¡Œï¼ˆä¾‹å¦‚ï¼Œæ–‡ä»¶[emplace.cpp](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fblob%2Fdevelop%2Fdoc%2Fexamples%2Femplace.cpp)ï¼‰ã€‚

### JSONä½œä¸ºä¸€çº§çš„æ•°æ®ç±»å‹

ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ï¼Œå¯ä»¥è®©æ‚¨äº†è§£å¦‚ä½•ä½¿ç”¨è¯¥ç±»ã€‚

å‡è®¾æ‚¨è¦åˆ›å»ºå¦‚ä¸‹çš„JSONå¯¹è±¡ï¼š

```source-c
{
  "pi": 3.141,
  "happy": true,
  "name": "Niels",
  "nothing": null,
  "answer": {
    "everything": 42
  },
  "list": [1, 0, 2],
  "object": {
    "currency": "USD",
    "value": 42.99
  }
}
```

ä½ å¯ä»¥è¿™æ ·å†™ï¼š

```source-c
// create an empty structure (null)
json j;

// add a number that is stored as double (note the implicit conversion of j to an object)
j["pi"] = 3.141;

// add a Boolean that is stored as bool
j["happy"] = true;

// add a string that is stored as std::string
j["name"] = "Niels";

// add another null object by passing nullptr
j["nothing"] = nullptr;

// add an object inside the object
j["answer"]["everything"] = 42;

// add an array that is stored as std::vector (using an initializer list)
j["list"] = { 1, 0, 2 };

// add another object (using an initializer list of pairs)
j["object"] = { {"currency", "USD"}, {"value", 42.99} };

// instead, you could also write (which looks very similar to the JSON above)
json j2 = {
  {"pi", 3.141},
  {"happy", true},
  {"name", "Niels"},
  {"nothing", nullptr},
  {"answer", {
    {"everything", 42}
  }},
  {"list", {1, 0, 2}},
  {"object", {
    {"currency", "USD"},
    {"value", 42.99}
  }}
};
```

è¯·æ³¨æ„ï¼Œåœ¨æ‰€æœ‰è¿™äº›æƒ…å†µä¸‹ï¼Œæ‚¨æ°¸è¿œä¸éœ€è¦â€œå‘Šè¯‰â€ç¼–è¯‘å™¨æ‚¨è¦ä½¿ç”¨å“ªç§JSONå€¼ç±»å‹ã€‚å¦‚æœä½ æƒ³æ˜¾æ€§æŒ‡å®šç±»å‹æˆ–è¡¨è¾¾ä¸€äº›ç‰¹å®šçš„æ„å›¾ï¼Œå‡½æ•°ï¼š[`json::array`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_aa80485befaffcadaa39965494e0b4d2e.html%23aa80485befaffcadaa39965494e0b4d2e)å’Œ[`json::object`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_aa13f7c0615867542ce80337cbcf13ada.html%23aa13f7c0615867542ce80337cbcf13ada)å¯æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼š

```php
// a way to express the empty array []
json empty_array_explicit = json::array();

// ways to express the empty object {}
json empty_object_implicit = json({});
json empty_object_explicit = json::object();

// a way to express an _array_ of key/value pairs [["currency", "USD"], ["value", 42.99]]
json array_not_object = json::array({ {"currency", "USD"}, {"value", 42.99} });
```

### åºåˆ—åŒ–/ååºåˆ—åŒ–

#### To/from strings

æ‚¨å¯ä»¥é€šè¿‡é™„åŠ `_json`åˆ°å­—ç¬¦ä¸²æ¥åˆ›å»ºJSONå€¼ï¼ˆååºåˆ—åŒ–ï¼‰ï¼š

```php
// create object from string literal
json j = "{ \"happy\": true, \"pi\": 3.141 }"_json;

// or even nicer with a raw string literal
auto j2 = R"(
  {
    "happy": true,
    "pi": 3.141
  }
)"_json;
```

è¯·æ³¨æ„ï¼Œå¦‚æœä¸é™„åŠ `_json`åç¼€ï¼Œåˆ™ä¸ä¼šè§£æä¼ é€’çš„å­—ç¬¦ä¸²æ–‡å­—ï¼Œè€Œåªæ˜¯ç”¨ä½œJSONå­—ç¬¦ä¸²å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`json j = "{ \"happy\": true, \"pi\": 3.141 }"`åªæ˜¯å­˜å‚¨å­—ç¬¦ä¸²`"{ "happy": true, "pi": 3.141 }"`è€Œä¸æ˜¯è§£æå®é™…å¯¹è±¡ã€‚

ä»¥ä¸Šç¤ºä¾‹ä¹Ÿå¯ä»¥ä½¿ç”¨[`json::parse()`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_aa9676414f2e36383c4b181fe856aa3c0.html%23aa9676414f2e36383c4b181fe856aa3c0)æ˜ç¡®è¡¨è¾¾ï¼š

```cpp
// parse explicitly
auto j3 = json::parse("{ \"happy\": true, \"pi\": 3.141 }");
```

æ‚¨è¿˜å¯ä»¥è·å–JSONå€¼çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼ˆåºåˆ—åŒ–ï¼‰ï¼š

```cpp
// explicit conversion to string
std::string s = j.dump();    // {\"happy\":true,\"pi\":3.141}

// serialization with pretty printing
// pass in the amount of spaces to indent
std::cout << j.dump(4) << std::endl;
// {
//     "happy": true,
//     "pi": 3.141
// }
```

æ³¨æ„åºåˆ—åŒ–å’Œèµ‹å€¼ä¹‹é—´çš„åŒºåˆ«ï¼š

```cpp
// store a string in a JSON value
json j_string = "this is a string";

// retrieve the string value (implicit JSON to std::string conversion)
std::string cpp_string = j_string;
// retrieve the string value (explicit JSON to std::string conversion)
auto cpp_string2 = j_string.get<std::string>();

// retrieve the serialized value (explicit JSON serialization)
std::string serialized_string = j_string.dump();

// output of original string
std::cout << cpp_string << " == " << cpp_string2 << " == " << j_string.get<std::string>() << '\n';
// output of serialized value
std::cout << j_string << " == " << serialized_string << std::endl;
```

[`.dump()`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_a5adea76fedba9898d404fef8598aa663.html%23a5adea76fedba9898d404fef8598aa663)å§‹ç»ˆè¿”å›åºåˆ—åŒ–å€¼ï¼Œè€Œ[`.get<std::string>()`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_a16f9445f7629f634221a42b967cdcd43.html%23a16f9445f7629f634221a42b967cdcd43)è¿”å›æœ€åˆå­˜å‚¨çš„å­—ç¬¦ä¸²å€¼ã€‚

è¯·æ³¨æ„ï¼Œè¯¥åº“ä»…æ”¯æŒUTF-8ã€‚å½“æ‚¨åœ¨åº“ä¸­å­˜å‚¨å…·æœ‰ä¸åŒç¼–ç çš„å­—ç¬¦ä¸²æ—¶ï¼Œè°ƒç”¨[`dump()`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_a5adea76fedba9898d404fef8598aa663.html%23a5adea76fedba9898d404fef8598aa663)å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

#### To/from streams (e.g. files, string streams)

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æµæ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š

```cpp
// deserialize from standard input
json j;
std::cin >> j;

// serialize to standard output
std::cout << j;

// the setw manipulator was overloaded to set the indentation for pretty printing
std::cout << std::setw(4) << j << std::endl;
```

è¿™äº›è¿ç®—ç¬¦é€‚ç”¨äº`std::istream`æˆ–`std::ostream`çš„ä»»ä½•å­ç±»ã€‚è¿™æ˜¯æ–‡ä»¶çš„ç±»ä¼¼ç¤ºä¾‹ï¼š

```cpp
// read a JSON file
std::ifstream i("file.json");
json j;
i >> j;

// write prettified JSON to another file
std::ofstream o("pretty.json");
o << std::setw(4) << j << std::endl;
```

è¯·æ³¨æ„ï¼Œä¸º`failbit`è®¾ç½®å¼‚å¸¸ä½ä¸é€‚ç”¨æ­¤ç”¨ä¾‹ã€‚ç”±äºä½¿ç”¨äº†`noexcept`è¯´æ˜ç¬¦ï¼Œå®ƒå°†å¯¼è‡´ç¨‹åºç»ˆæ­¢ã€‚

#### ä»è¿­ä»£å™¨èŒƒå›´è¯»å–

æ‚¨è¿˜å¯ä»¥ä»è¿­ä»£å™¨èŒƒå›´è§£æJSON; ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶å­˜å‚¨å†…å®¹ä¸ºè¿ç»­çš„å­—èŠ‚åºåˆ—ï¼Œå¯ä»è¿­ä»£å™¨è®¿é—®çš„ä»»ä½•å®¹å™¨ï¼Œä¾‹å¦‚std::vector<std::uint8_t>ï¼š

```cpp
std::vector<std::uint8_t> v = {'t', 'r', 'u', 'e'};
json j = json::parse(v.begin(), v.end());
```

æ‚¨ä¹Ÿå¯ä»¥å»æ‰èŒƒå›´[begin, end)æ“ä½œç¬¦ï¼š

```cpp
std::vector<std::uint8_t> v = {'t', 'r', 'u', 'e'};
json j = json::parse(v);
```

#### SAX interface(å¾…è¡¥å……)

### STL-like access

æˆ‘ä»¬å®šä¹‰çš„JSONç±»çš„è¡Œä¸ºä¸STLå®¹å™¨ä¸€æ ·ã€‚äº‹å®ä¸Šï¼Œå®ƒéµå¾ª[**ReversibleContainer**](https://links.jianshu.com/go?to=https%3A%2F%2Fen.cppreference.com%2Fw%2Fcpp%2Fnamed_req%2FReversibleContainer)è§„èŒƒã€‚

```cpp
// create an array using push_back
json j;
j.push_back("foo");
j.push_back(1);
j.push_back(true);

// also use emplace_back
j.emplace_back(1.78);

// iterate the array
for (json::iterator it = j.begin(); it != j.end(); ++it) {
  std::cout << *it << '\n';
}

// range-based for
for (auto& element : j) {
  std::cout << element << '\n';
}

// getter/setter
const std::string tmp = j[0];
j[1] = 42;
bool foo = j.at(2);

// comparison
j == "[\"foo\", 1, true]"_json;  // true

// other stuff
j.size();     // 3 entries
j.empty();    // false
j.type();     // json::value_t::array
j.clear();    // the array is empty again

// convenience type checkers
j.is_null();
j.is_boolean();
j.is_number();
j.is_object();
j.is_array();
j.is_string();

// create an object
json o;
o["foo"] = 23;
o["bar"] = false;
o["baz"] = 3.141;

// also use emplace
o.emplace("weather", "sunny");

// special iterator member functions for objects
for (json::iterator it = o.begin(); it != o.end(); ++it) {
  std::cout << it.key() << " : " << it.value() << "\n";
}

// find an entry
if (o.find("foo") != o.end()) {
  // there is an entry with key "foo"
}

// or simpler using count()
int foo_present = o.count("foo"); // 1
int fob_present = o.count("fob"); // 0

// delete an entry
o.erase("foo");
```

### ä»STLå®¹å™¨è½¬æ¢

ä»»ä½•åºåˆ—å®¹å™¨ï¼ˆstd::arrayï¼Œstd::vectorï¼Œstd::dequeï¼Œstd::forward_listï¼Œstd::listï¼‰ï¼Œå…¶å€¼å¯ä»¥è¢«ç”¨äºæ„å»ºJSONå€¼ï¼ˆä¾‹å¦‚ï¼Œæ•´æ•°ï¼Œæµ®ç‚¹æ•°ï¼Œå¸ƒå°”å€¼ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œæˆ–è€…åœ¨æœ¬èŠ‚ä¸­æè¿°çš„STLå®¹å™¨ï¼‰éƒ½å¯è¢«ç”¨äºåˆ›å»ºJSONæ•°ç»„ã€‚è¿™åŒæ ·é€‚ç”¨äºç±»ä¼¼çš„å…³è”å®¹å™¨ï¼ˆstd::setï¼Œstd::multisetï¼Œstd::unordered_setï¼Œstd::unordered_multisetï¼‰ï¼Œä½†æ˜¯åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ çš„é¡ºåºå–å†³äºå…ƒç´ æ˜¯å¦‚ä½•åœ¨å„ä¸ªSTLå®¹å™¨æ’åºã€‚

```cpp
std::vector<int> c_vector {1, 2, 3, 4};
json j_vec(c_vector);
// [1, 2, 3, 4]

std::deque<double> c_deque {1.2, 2.3, 3.4, 5.6};
json j_deque(c_deque);
// [1.2, 2.3, 3.4, 5.6]

std::list<bool> c_list {true, true, false, true};
json j_list(c_list);
// [true, true, false, true]

std::forward_list<int64_t> c_flist {12345678909876, 23456789098765, 34567890987654, 45678909876543};
json j_flist(c_flist);
// [12345678909876, 23456789098765, 34567890987654, 45678909876543]

std::array<unsigned long, 4> c_array {{1, 2, 3, 4}};
json j_array(c_array);
// [1, 2, 3, 4]

std::set<std::string> c_set {"one", "two", "three", "four", "one"};
json j_set(c_set); // only one entry for "one" is used
// ["four", "one", "three", "two"]

std::unordered_set<std::string> c_uset {"one", "two", "three", "four", "one"};
json j_uset(c_uset); // only one entry for "one" is used
// maybe ["two", "three", "four", "one"]

std::multiset<std::string> c_mset {"one", "two", "one", "four"};
json j_mset(c_mset); // both entries for "one" are used
// maybe ["one", "two", "one", "four"]

std::unordered_multiset<std::string> c_umset {"one", "two", "one", "four"};
json j_umset(c_umset); // both entries for "one" are used
// maybe ["one", "two", "one", "four"]
```

åŒæ ·ï¼Œä»»ä½•é”®å€¼å¯¹å®¹å™¨ï¼ˆstd::mapï¼Œstd::multimapï¼Œstd::unordered_mapï¼Œstd::unordered_multimapï¼‰ï¼Œå…¶é”®å¯ä»¥æ„é€ ä¸€ä¸ªstd::stringï¼Œå¹¶ä¸”å…¶å€¼å¯ä»¥è¢«ç”¨äºæ„å»ºJSONå€¼ï¼ˆè§ä¸Šæ–‡ç¤ºä¾‹ï¼‰å¯ç”¨äºåˆ›å»ºä¸€ä¸ªJSONå¯¹è±¡ã€‚è¯·æ³¨æ„ï¼Œåœ¨å¤šæ˜ å°„çš„æƒ…å†µä¸‹ï¼ŒJSONå¯¹è±¡ä¸­åªä½¿ç”¨ä¸€ä¸ªé”®ï¼Œå€¼å–å†³äºSTLå®¹å™¨çš„å†…éƒ¨é¡ºåºã€‚

```cpp
std::map<std::string, int> c_map { {"one", 1}, {"two", 2}, {"three", 3} };
json j_map(c_map);
// {"one": 1, "three": 3, "two": 2 }

std::unordered_map<const char*, double> c_umap { {"one", 1.2}, {"two", 2.3}, {"three", 3.4} };
json j_umap(c_umap);
// {"one": 1.2, "two": 2.3, "three": 3.4}

std::multimap<std::string, bool> c_mmap { {"one", true}, {"two", true}, {"three", false}, {"three", true} };
json j_mmap(c_mmap); // only one entry for key "three" is used
// maybe {"one": true, "two": true, "three": true}

std::unordered_multimap<std::string, bool> c_ummap { {"one", true}, {"two", true}, {"three", false}, {"three", true} };
json j_ummap(c_ummap); // only one entry for key "three" is used
// maybe {"one": true, "two": true, "three": true}
```

### JSON Pointerå’ŒJSON Patch

è¯¥åº“æ”¯æŒ**JSON Pointer**ï¼ˆ[RFC 6901](https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc6901)ï¼‰ä½œä¸ºå¤„ç†ç»“æ„åŒ–å€¼çš„æ›¿ä»£æ–¹æ³•ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œ**JSON Patch**ï¼ˆ[RFC 6902](https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc6902)ï¼‰å…è®¸æè¿°ä¸¤ä¸ªJSONå€¼ä¹‹é—´çš„å·®å¼‚ - æœ‰æ•ˆåœ°å…è®¸Unixä¸­å·²çŸ¥çš„patchå’Œdiffæ“ä½œã€‚

```bash
// a JSON value
json j_original = R"({
  "baz": ["one", "two", "three"],
  "foo": "bar"
})"_json;

// access members with a JSON pointer (RFC 6901)
j_original["/baz/1"_json_pointer];
// "two"

// a JSON patch (RFC 6902)
json j_patch = R"([
  { "op": "replace", "path": "/baz", "value": "boo" },
  { "op": "add", "path": "/hello", "value": ["world"] },
  { "op": "remove", "path": "/foo"}
])"_json;

// apply the patch
json j_result = j_original.patch(j_patch);
// {
//    "baz": "boo",
//    "hello": ["world"]
// }

// calculate a JSON patch from two JSON values
json::diff(j_result, j_original);
// [
//   { "op":" replace", "path": "/baz", "value": ["one", "two", "three"] },
//   { "op": "remove","path": "/hello" },
//   { "op": "add", "path": "/foo", "value": "bar" }
// ]
```

### JSONåˆå¹¶Patch

è¯¥åº“æ”¯æŒ**JSON Merge Patch**ï¼ˆ[RFC 7386](https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7386)ï¼‰ä½œä¸ºè¡¥ä¸æ ¼å¼ã€‚å®ƒä¸æ˜¯ä½¿ç”¨JSONæŒ‡é’ˆï¼ˆå‚è§ä¸Šæ–‡ï¼‰æ¥æŒ‡å®šè¦æ“ä½œçš„å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸æ‰€ä¿®æ”¹æ–‡æ¡£éå¸¸ç›¸ä¼¼çš„è¯­æ³•æ¥æè¿°æ›´æ”¹ã€‚

```swift
// a JSON value
json j_document = R"({
  "a": "b",
  "c": {
    "d": "e",
    "f": "g"
  }
})"_json;

// a patch
json j_patch = R"({
  "a":"z",
  "c": {
    "f": null
  }
})"_json;

// apply the patch
j_original.merge_patch(j_patch);
// {
//  "a": "z",
//  "c": {
//    "d": "e"
//  }
// }
```

éšå¼è½¬æ¢  
JSONå¯¹è±¡çš„ç±»å‹ç”±è¦å­˜å‚¨çš„è¡¨è¾¾å¼è‡ªåŠ¨ç¡®å®šã€‚åŒæ ·ï¼Œéšå¼è½¬æ¢å­˜å‚¨çš„å€¼ã€‚

```cpp
// strings
std::string s1 = "Hello, world!";
json js = s1;
std::string s2 = js;

// Booleans
bool b1 = true;
json jb = b1;
bool b2 = jb;

// numbers
int i = 42;
json jn = i;
double f = jn;

// etc.
```

æ‚¨ä¹Ÿå¯ä»¥æ˜¾å¼è¯·æ±‚å€¼ï¼š

```cpp
std::string vs = js.get<std::string>();
bool vb = jb.get<bool>();
int vi = jn.get<int>();

// etc.
```

è¯·æ³¨æ„`char`ç±»å‹ä¸èƒ½è‡ªåŠ¨è½¬æ¢æˆJSONå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯è½¬æ¢æˆæ•´å‹æ•°ã€‚è¦è½¬æ¢æˆå­—ç¬¦ä¸²å¿…é¡»æ˜¾å¼æŒ‡å®šï¼š

```cpp
char ch = 'A';                       // ASCII value 65
json j_default = ch;                 // stores integer number 65
json j_string = std::string(1, ch);  // stores string "A"
```

### ä»»æ„ç±»å‹è½¬æ¢

ä»»ä½•ç±»å‹éƒ½å¯ä»¥ç”¨JSONåºåˆ—åŒ–ï¼Œè€Œä¸ä»…ä»…æ˜¯STLå®¹å™¨å’Œæ ‡é‡ç±»å‹ã€‚é€šå¸¸ï¼Œæ‚¨å°†éµå¾ªè¿™äº›å‡†ç»³æ¥åšäº‹ï¼š

```cpp
namespace ns {
    // a simple struct to model a person
    struct person {
        std::string name;
        std::string address;
        int age;
    };
}

ns::person p = {"Ned Flanders", "744 Evergreen Terrace", 60};

// convert to JSON: copy each value into the JSON object
json j;
j["name"] = p.name;
j["address"] = p.address;
j["age"] = p.age;

// ...

// convert from JSON: copy each value from the JSON object
ns::person p {
    j["name"].get<std::string>(),
    j["address"].get<std::string>(),
    j["age"].get<int>()
};
```

è¿™ä¸ªä»£ç æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æœ‰ç‚¹å•°å—¦ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´å¥½çš„åŠæ³•ï¼š

```cpp
// create a person
ns::person p {"Ned Flanders", "744 Evergreen Terrace", 60};

// conversion: person -> json
json j = p;

std::cout << j << std::endl;
// {"address":"744 Evergreen Terrace","age":60,"name":"Ned Flanders"}

// conversion: json -> person
ns::person p2 = j;

// that's it
assert(p == p2);
```

#### åŸºæœ¬ç”¨æ³•

è¦ä½¿å…¶é€‚ç”¨äºæ‚¨çš„æŸç§ç±»å‹ï¼Œæ‚¨åªéœ€æä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼š

```cpp
using nlohmann::json;

namespace ns {
    void to_json(json& j, const person& p) {
        j = json{{"name", p.name}, {"address", p.address}, {"age", p.age}};
    }

    void from_json(const json& j, person& p) {
        p.name = j.at("name").get<std::string>();
        p.address = j.at("address").get<std::string>();
        p.age = j.at("age").get<int>();
    }
} // namespace ns
```

å°±è¿™ä¹ˆç®€å•ï¼`json`ä½¿ç”¨æ‚¨çš„ç±»å‹è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼Œæ‚¨çš„è‡ªå®šä¹‰æ–¹æ³•`to_json`å°†è¢«è‡ªåŠ¨è°ƒç”¨ã€‚åŒæ ·ï¼Œåœ¨è°ƒç”¨`get<your_type>()`æ—¶ï¼Œ`from_json`å°†è¢«è‡ªåŠ¨è°ƒç”¨ã€‚  
ä¸€äº›é‡è¦çš„ç‚¹ï¼š

- é‚£äº›æ–¹æ³•**å¿…é¡»**åœ¨ä½ çš„ç±»å‹çš„å‘½åç©ºé—´ï¼ˆå¯ä»¥æ˜¯å…¨å±€å‘½åç©ºé—´ï¼‰ä¸­ï¼Œå¦åˆ™åº“å°†æ— æ³•æ‰¾åˆ°å®ƒä»¬ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`person`åœ¨å‘½åç©ºé—´ä¸­`ns`ä¸­å®šä¹‰ï¼‰ã€‚
- åœ¨æ‚¨ä½¿ç”¨éšå¼è½¬æ¢çš„åœ°æ–¹ï¼Œé‚£äº›æ–¹æ³•å¿…é¡»æ˜¯æœ‰æ•ˆçš„ï¼ˆä¾‹å¦‚ï¼šæ­£ç¡®çš„å¤´æ–‡ä»¶å¿…é¡»è¢«åŒ…å«ï¼‰æŸ¥çœ‹[é—®é¢˜1108](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fissues%2F1108)ï¼Œäº†è§£å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚
- ä½¿ç”¨`get<your_type>()`æ—¶ï¼Œ`your_type`Â **å¿…é¡»**æ˜¯[DefaultConstructible](https://links.jianshu.com/go?to=https%3A%2F%2Fen.cppreference.com%2Fw%2Fcpp%2Fnamed_req%2FDefaultConstructible)ã€‚ï¼ˆåé¢ä¼šæè¿°ä¸€ç§å¯ä»¥ç»•è¿‡è¿™ä¸ªè¦æ±‚çš„æ–¹æ³•ã€‚ï¼‰
- åœ¨å‡½æ•°`from_json`ä¸­ï¼Œä½¿ç”¨å‡½æ•°[`at()`](https://links.jianshu.com/go?to=https%3A%2F%2Fnlohmann.github.io%2Fjson%2Fclassnlohmann_1_1basic__json_a93403e803947b86f4da2d1fb3345cf2c.html%23a93403e803947b86f4da2d1fb3345cf2c)æ¥è®¿é—®å¯¹è±¡å€¼è€Œä¸æ˜¯`operator[]`ã€‚å¦‚æœæŸä¸ªé”®ä¸å­˜åœ¨ï¼Œåˆ™`at`æŠ›å‡ºä¸€ä¸ªå¯ä»¥å¤„ç†çš„å¼‚å¸¸ï¼Œç„¶è€Œ`operator[]`æ˜¾ç¤ºæœªå®šä¹‰çš„è¡Œä¸ºã€‚
- å¦‚æœæ‚¨çš„ç±»å‹åŒ…å«å¤šä¸ª`operator=`å®šä¹‰ï¼Œåˆ™ä»£ç `your_variable = your_json;`Â [å¯èƒ½æ— æ³•ç¼–è¯‘](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fissues%2F667)ã€‚æ‚¨éœ€è¦æ”¹å†™æˆ`your_variable = your_json.get<decltype your_variable>();`ã€‚
- æ‚¨ä¸éœ€è¦ä¸ºSTLç±»å‹æ·»åŠ åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ç¨‹åºï¼Œä¾‹å¦‚`std::vector`ï¼šåº“å·²ç»å®ç°äº†è¿™äº›ã€‚
- æ³¨æ„å‡½æ•°`from_json`/Â `to_json`çš„å®šä¹‰é¡ºåºï¼šå¦‚æœä¸€ä¸ªç±»å‹`B`æœ‰ç±»å‹çš„æˆå‘˜`A`ï¼Œä½ **å¿…é¡»**åœ¨å®šä¹‰`to_json(B)`ä¹‹å‰ï¼Œå®šä¹‰`to_json(A)`ã€‚è¯·æŸ¥çœ‹[é—®é¢˜561](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fissues%2F561)ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

#### æ€ä¹ˆè½¬æ¢ç¬¬ä¸‰æ–¹åº“çš„ç±»å‹ï¼Ÿ

è¿™éœ€è¦æ›´é«˜çº§çš„æŠ€æœ¯ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ç§è½¬æ¢æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š  
è¯¥åº“ä½¿ç”¨**JSON Serializers**å°†ç±»å‹è½¬æ¢æˆjsonã€‚`nlohmann::json`çš„é»˜è®¤åºåˆ—åŒ–ç¨‹åºæ˜¯`nlohmann::adl_serializer`(ADL meansÂ [Argument-Dependent Lookup](https://links.jianshu.com/go?to=https%3A%2F%2Fen.cppreference.com%2Fw%2Fcpp%2Flanguage%2Fadl))ã€‚  
å®ƒæ˜¯è¿™æ ·å®ç°çš„ï¼ˆç®€åŒ–ï¼‰ï¼š

```cpp
template <typename T>
struct adl_serializer {
    static void to_json(json& j, const T& value) {
        // calls the "to_json" method in T's namespace
    }

    static void from_json(const json& j, T& value) {
        // same thing, but with the "from_json" method
    }
};
```

å½“æ‚¨æ§åˆ¶ç±»å‹çš„å‘½åç©ºé—´æ—¶ï¼Œæ­¤åºåˆ—åŒ–ç¨‹åºå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯ï¼Œ`boost::optional`æˆ–è€…`std::filesystem::path(C ++ 17)`å‘¢ï¼Ÿç›—ç”¨`boost`å‘½åç©ºé—´æ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œå¹¶ä¸”å‘stlä¸­æ·»åŠ æ¨¡æ¿ç‰¹åŒ–ä»¥å¤–çš„ä¸œè¥¿æ˜¯éæ³•......  
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨éœ€è¦å‘å‘½åç©ºé—´`nlohmann`ä¸­æ·»åŠ `adl_serializer`ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```cpp
// partial specialization (full specialization works too)
namespace nlohmann {
   template <typename T>
   struct adl_serializer<boost::optional<T>> {
       static void to_json(json& j, const boost::optional<T>& opt) {
           if (opt == boost::none) {
               j = nullptr;
           } else {
             j = *opt; // this will call adl_serializer<T>::to_json which will
                       // find the free function to_json in T's namespace!
           }
       }

       static void from_json(const json& j, boost::optional<T>& opt) {
           if (j.is_null()) {
               opt = boost::none;
           } else {
               opt = j.get<T>(); // same as above, but with
                                 // adl_serializer<T>::from_json
           }
       }
   };
}
```

#### å¦‚ä½•åœ¨æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°æˆ–ä¸å¯æ‹·è´çš„ç±»å‹ä½¿ç”¨`get()`ï¼Ÿ

æœ‰ä¸ªåŠæ³•ï¼Œå¦‚æœæ‚¨çš„ç±»å‹æ˜¯[MoveConstructible](https://links.jianshu.com/go?to=https%3A%2F%2Fen.cppreference.com%2Fw%2Fcpp%2Fnamed_req%2FMoveConstructible)çš„ã€‚æ‚¨ä¹Ÿå°†éœ€è¦ç‰¹åŒ–`adl_serializer`ï¼Œé‡è½½`from_json`ï¼š

```cpp
struct move_only_type {
    move_only_type() = delete;
    move_only_type(int ii): i(ii) {}
    move_only_type(const move_only_type&) = delete;
    move_only_type(move_only_type&&) = default;

    int i;
};

namespace nlohmann {
    template <>
    struct adl_serializer<move_only_type> {
        // note: the return type is no longer 'void', and the method only takes
        // one argument
        static move_only_type from_json(const json& j) {
            return {j.get<int>()};
        }

        // Here's the catch! You must provide a to_json method! Otherwise you
        // will not be able to convert move_only_type to json, since you fully
        // specialized adl_serializer on that type
        static void to_json(json& j, move_only_type t) {
            j = t.i;
        }
    };
}
```

#### æ€ä¹ˆç¼–å†™è‡ªå·±çš„åºåˆ—åŒ–ç¨‹åºï¼Ÿï¼ˆé«˜çº§ç”¨é€”ï¼‰

æ‚¨å¯ä»¥çœ‹ä¸‹åœ¨æµ‹è¯•å¥—ä»¶[`unit-udt.cpp`](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fnlohmann%2Fjson%2Fblob%2Fdevelop%2Ftest%2Fsrc%2Funit-udt.cpp)æŸ¥çœ‹ä¸€äº›ç¤ºä¾‹ã€‚  
å¦‚æœæ‚¨ç¼–å†™è‡ªå·±çš„åºåˆ—åŒ–ç¨‹åºï¼Œåˆ™éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- å¯¹`basic_json`ï¼Œä½¿ç”¨ä¸Â `nlohmann::json`ä¸­ä¸åŒçš„åˆ«åï¼ˆ`basic_json`çš„æœ€åä¸€ä¸ªæ¨¡æ¿å‚æ•°æ˜¯`JSONSerializer`ï¼‰
- åœ¨æ‚¨æ‰€æœ‰çš„`to_json`/`from_json`å‡½æ•°ä¸­ï¼Œä½¿ç”¨æ‚¨å¯¹`basic_json`èµ·çš„åˆ«åï¼ˆæˆ–æ¨¡æ¿å‚æ•°ï¼‰ã€‚
- å½“æ‚¨éœ€è¦ADLæ—¶ï¼Œä½¿ç”¨`nlohmann::to_json`å’Œ`nlohmann::from_json`

ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œåªæ¥å—å¤§å°<=32çš„ç±»å‹å¹¶ä¸”ä½¿ç”¨ADLã€‚

```cpp
// You should use void as a second template argument
// if you don't need compile-time checks on T
template<typename T, typename SFINAE = typename std::enable_if<sizeof(T) <= 32>::type>
struct less_than_32_serializer {
    template <typename BasicJsonType>
    static void to_json(BasicJsonType& j, T value) {
        // we want to use ADL, and call the correct to_json overload
        using nlohmann::to_json; // this method is called by adl_serializer,
                                 // this is where the magic happens
        to_json(j, value);
    }

    template <typename BasicJsonType>
    static void from_json(const BasicJsonType& j, T& value) {
        // same thing here
        using nlohmann::from_json;
        from_json(j, value);
    }
};
```

é‡æ–°å®ç°åºåˆ—åŒ–ç¨‹åºæ—¶ï¼Œè¦**éå¸¸**å°å¿ƒï¼Œå¦‚æœä¸æ³¨æ„ï¼Œå¯èƒ½å †æ ˆæº¢å‡ºï¼š

```source-c
template <typename T, void>
struct bad_serializer
{
    template <typename BasicJsonType>
    static void to_json(BasicJsonType& j, const T& value) {
      // this calls BasicJsonType::json_serializer<T>::to_json(j, value);
      // if BasicJsonType::json_serializer == bad_serializer ... oops!
      j = value;
    }

    template <typename BasicJsonType>
    static void to_json(const BasicJsonType& j, T& value) {
      // this calls BasicJsonType::json_serializer<T>::from_json(j, value);
      // if BasicJsonType::json_serializer == bad_serializer ... oops!
      value = j.template get<T>(); // oops!
    }
};
```

### äºŒè¿›åˆ¶æ ¼å¼(CBOR, MessagePack, and UBJSON)

è™½ç„¶JSONæ˜¯ä¸€ç§æ™®éå­˜åœ¨çš„æ•°æ®æ ¼å¼ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸€ç§éå¸¸ç´§å‡‘çš„æ ¼å¼ï¼Œé€‚ç”¨äºæ•°æ®äº¤æ¢ï¼Œä¾‹å¦‚é€šè¿‡ç½‘ç»œã€‚å› ä¸ºï¼Œè¯¥åº“æ”¯æŒ[CBOR](https://links.jianshu.com/go?to=http%3A%2F%2Fcbor.io%2F)Â (ç®€æ˜äºŒè¿›åˆ¶å¯¹è±¡è¡¨ç¤º)ï¼Œ[MessagePack](https://links.jianshu.com/go?to=http%3A%2F%2Fmsgpack.org%2F)å’Œ[UBJSON](https://links.jianshu.com/go?to=http%3A%2F%2Fubjson.org%2F)Â (é€šç”¨äºŒè¿›åˆ¶è§„èŒƒ)ä»¥æœ‰æ•ˆåœ°å°†JSONå€¼ç¼–ç ä¸ºå­—èŠ‚å‘é‡å’Œè§£ç æ­¤ç±»å‘é‡ã€‚

```source-c
// create a JSON value
json j = R"({"compact": true, "schema": 0})"_json;

// serialize to CBOR
std::vector<std::uint8_t> v_cbor = json::to_cbor(j);

// 0xA2, 0x67, 0x63, 0x6F, 0x6D, 0x70, 0x61, 0x63, 0x74, 0xF5, 0x66, 0x73, 0x63, 0x68, 0x65, 0x6D, 0x61, 0x00

// roundtrip
json j_from_cbor = json::from_cbor(v_cbor);

// serialize to MessagePack
std::vector<std::uint8_t> v_msgpack = json::to_msgpack(j);

// 0x82, 0xA7, 0x63, 0x6F, 0x6D, 0x70, 0x61, 0x63, 0x74, 0xC3, 0xA6, 0x73, 0x63, 0x68, 0x65, 0x6D, 0x61, 0x00

// roundtrip
json j_from_msgpack = json::from_msgpack(v_msgpack);

// serialize to UBJSON
std::vector<std::uint8_t> v_ubjson = json::to_ubjson(j);

// 0x7B, 0x69, 0x07, 0x63, 0x6F, 0x6D, 0x70, 0x61, 0x63, 0x74, 0x54, 0x69, 0x06, 0x73, 0x63, 0x68, 0x65, 0x6D, 0x61, 0x69, 0x00, 0x7D

// roundtrip
json j_from_ubjson = json::from_ubjson(v_ubjson);
```